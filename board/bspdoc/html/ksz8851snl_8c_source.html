<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Board Support Package: common/drivers/ksz8851snl.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_c5ab7d5005c5f96afef39cd6ff9e2484.html">common</a>&nbsp;&raquo;&nbsp;<a class="el" href="dir_640347b79a58de25a4e6f9b018e8e1be.html">drivers</a>
  </div>
</div>
<div class="contents">
<h1>ksz8851snl.c</h1><a href="ksz8851snl_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/***************************************************************************/</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="ksz8851snl_8h.html" title="Driver for Micrel KSZ8851SNL ethernet controller.">ksz8851snl.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="ethspi_8h.html" title="API for SPI Interface to Micrel KSZ8851SNL ethernet controller.">ethspi.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;em_gpio.h&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00039"></a>00039 
<a name="l00041"></a>00041 <span class="keyword">static</span> uint16_t frameId = 0;        
<a name="l00042"></a>00042 <span class="keyword">static</span> uint8_t  macAddress[6];      
<a name="l00044"></a>00044 <span class="preprocessor">#if KSZ8851SNL_DEBUG</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>     KSZ8851SNL_SetDigitalLoopbackMode(<span class="keywordtype">void</span>);
<a name="l00046"></a>00046 <span class="keyword">static</span> <span class="keywordtype">void</span>     KSZ8851SNL_DumpRegisters(<span class="keywordtype">void</span>);
<a name="l00047"></a>00047 <span class="preprocessor">#endif </span><span class="comment">/* KSZ8851SNL_DEBUG */</span>
<a name="l00048"></a>00048 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc" title="Prints a message with a predetermined exception level Support method used for debugging...">KSZ8851SNL_ExceptionHandler</a>(<span class="keyword">enum</span> <a class="code" href="group__ksz8851snl.html#gae706783edc2cc1b3a192bd17946cad46" title="enumeration used for exception handling">exceptionType_e</a> exc_type, <span class="keywordtype">char</span>* param);
<a name="l00049"></a>00049 <span class="keyword">static</span> <span class="keywordtype">void</span>     <a class="code" href="ksz8851snl_8c.html#a92d3dd835f6bf9055f25702d288adbe6" title="Realease the current frame if it is inconsistent.">KSZ8851SNL_ReleaseIncosistentFrame</a>(<span class="keywordtype">void</span>);
<a name="l00050"></a>00050 <span class="keyword">static</span> uint8_t  <a class="code" href="ksz8851snl_8c.html#a77477ac338cf16f8a8c76426cddafe08" title="Returns the difference in bytes to be DWORD alligned.">KSZ8851SNL_DwordAllignDiff</a>(uint8_t val);
<a name="l00053"></a>00053 <span class="comment">/**************************************************************************/</span>
<a name="l00056"></a><a class="code" href="group__ksz8851snl.html#gacc125e35e034dde5ccfdf0976e561cd9">00056</a> <span class="keywordtype">void</span> <a class="code" href="group__ksz8851snl.html#gacc125e35e034dde5ccfdf0976e561cd9" title="enables the chip interrupts">KSZ8851SNL_EnableInterupts</a>(<span class="keywordtype">void</span>)
<a name="l00057"></a>00057 {
<a name="l00058"></a>00058   uint16_t data;
<a name="l00059"></a>00059   <span class="comment">/* Enable interupts */</span>
<a name="l00060"></a>00060   data = <a class="code" href="group__ksz8851snl.html#ga1f20727c5c478956c891fb9919bdf338" title="Interrupt mask initialization collection.">INT_MASK_EXAMPLE</a>;
<a name="l00061"></a>00061   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="comment">/***************************************************************************/</span>
<a name="l00075"></a><a class="code" href="group__ksz8851snl.html#gae08002b752cd0a410e46bd5b2f77807a">00075</a> uint16_t <a class="code" href="group__ksz8851snl.html#gae08002b752cd0a410e46bd5b2f77807a" title="Checks for any interrrupts and if found, clears their status and prepair for interrupt...">KSZ8851SNL_CheckIrqStat</a>(<span class="keywordtype">void</span>)
<a name="l00076"></a>00076 {
<a name="l00077"></a>00077   uint16_t data, ISR_stat, found_INT;
<a name="l00078"></a>00078   found_INT = 0;
<a name="l00079"></a>00079   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;ISR_stat);
<a name="l00080"></a>00080 
<a name="l00081"></a>00081   <span class="comment">/* Disable interupts on KSZ8851SNL */</span>
<a name="l00082"></a>00082   data = <a class="code" href="group__ksz8851snl.html#ga359afd6937727dbe8deee27136244dde" title="Used to disable the interupts.">NO_INT</a>;
<a name="l00083"></a>00083   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00084"></a>00084 
<a name="l00085"></a>00085   <span class="comment">/* Resolve the RX completion interrupt */</span>
<a name="l00086"></a>00086   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#gadba185a1a6a0f68f870e20e897ed3d0f" title="Enable receive interrupt.">INT_RX_DONE</a>)
<a name="l00087"></a>00087   {
<a name="l00088"></a>00088     <span class="comment">/* Clear RX Interrupt flag */</span>
<a name="l00089"></a>00089     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00090"></a>00090     data = INT_RX_DONE;
<a name="l00091"></a>00091     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00092"></a>00092     found_INT |= INT_RX_DONE;
<a name="l00093"></a>00093   }
<a name="l00094"></a>00094   <span class="comment">/* Resolve the Link change interrupt */</span>
<a name="l00095"></a>00095   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#ga7e4034f1f2767d77e5590ebfcbe9c631" title="Enable link change interrupt.">INT_LINK_CHANGE</a>)
<a name="l00096"></a>00096   {
<a name="l00097"></a>00097     <span class="comment">/* Clear Link change Interrupt flag */</span>
<a name="l00098"></a>00098     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00099"></a>00099     data = INT_LINK_CHANGE;
<a name="l00100"></a>00100     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00101"></a>00101     found_INT |= INT_LINK_CHANGE;
<a name="l00102"></a>00102   }
<a name="l00103"></a>00103   <span class="comment">/* Resolve the RX overrun interrupt */</span>
<a name="l00104"></a>00104   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#gaffc2583e4d700924d32f60b1fcf015eb" title="Enable receive overrun interrupt.">INT_RX_OVERRUN</a>)
<a name="l00105"></a>00105   {
<a name="l00106"></a>00106     <span class="comment">/* Clear RX overrun Interrupt flag */</span>
<a name="l00107"></a>00107     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00108"></a>00108     data = INT_RX_OVERRUN;
<a name="l00109"></a>00109     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00110"></a>00110     found_INT |= INT_RX_OVERRUN;
<a name="l00111"></a>00111   }
<a name="l00112"></a>00112   <span class="comment">/* Resolve the TX stopped interrupt */</span>
<a name="l00113"></a>00113   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#ga110c41b33eafca19b20fb2be6fb72c46" title="Enable transmit process stopped interrupt.">INT_TX_STOPPED</a>)
<a name="l00114"></a>00114   {
<a name="l00115"></a>00115     <span class="comment">/* Clear TX stopped Interrupt flag */</span>
<a name="l00116"></a>00116     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00117"></a>00117     data = INT_TX_STOPPED;
<a name="l00118"></a>00118     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00119"></a>00119     found_INT |= INT_TX_STOPPED;
<a name="l00120"></a>00120   }
<a name="l00121"></a>00121   <span class="comment">/* Resolve the RX stopped interrupt */</span>
<a name="l00122"></a>00122   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#ga75f7348680dc57c5a1b5576f19202221" title="Enable receive process stopped interrupt.">INT_RX_STOPPED</a>)
<a name="l00123"></a>00123   {
<a name="l00124"></a>00124     <span class="comment">/* Clear RX stopped Interrupt flag */</span>
<a name="l00125"></a>00125     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00126"></a>00126     data = INT_RX_STOPPED;
<a name="l00127"></a>00127     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00128"></a>00128     found_INT |= INT_RX_STOPPED;
<a name="l00129"></a>00129   }
<a name="l00130"></a>00130   <span class="comment">/* Resolve the RX of a WakeOnLan frame interrupt */</span>
<a name="l00131"></a>00131   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#ga9d608d24f862badcf6a82775795857b1" title="Enable WOL on receive wake-up frame detect interrupt.">INT_RX_WOL_FRAME</a>)
<a name="l00132"></a>00132   {
<a name="l00133"></a>00133     <span class="comment">/* Clear RX of a WakeOnLan Interrupt flag */</span>
<a name="l00134"></a>00134     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00135"></a>00135     data = INT_RX_WOL_FRAME;
<a name="l00136"></a>00136     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00137"></a>00137     found_INT |= INT_RX_WOL_FRAME;
<a name="l00138"></a>00138   }
<a name="l00139"></a>00139   <span class="comment">/* Resolve the RX of a magic frame interrupt */</span>
<a name="l00140"></a>00140   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#ga4a2d1fc75370d29b93e356752b2c5db3" title="Enable magic packet detect interrupt.">INT_MAGIC</a>)
<a name="l00141"></a>00141   {
<a name="l00142"></a>00142     <span class="comment">/* Clear RX of a magic frame Interrupt flag */</span>
<a name="l00143"></a>00143     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00144"></a>00144     data = INT_MAGIC;
<a name="l00145"></a>00145     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00146"></a>00146     found_INT |= INT_MAGIC;
<a name="l00147"></a>00147   }
<a name="l00148"></a>00148   <span class="comment">/* Resolve the RX of a LINKUP interrupt */</span>
<a name="l00149"></a>00149   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#ga38a22f7080864fb5da04f847db02f9b0" title="Enable link up detect interrupt.">INT_LINKUP</a>)
<a name="l00150"></a>00150   {
<a name="l00151"></a>00151     <span class="comment">/* Clear RX of a LINKUP Interrupt flag */</span>
<a name="l00152"></a>00152     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00153"></a>00153     data = INT_LINKUP;
<a name="l00154"></a>00154     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00155"></a>00155     found_INT |= INT_LINKUP;
<a name="l00156"></a>00156   }
<a name="l00157"></a>00157   <span class="comment">/* Resolve the RX of a Energy interrupt */</span>
<a name="l00158"></a>00158   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#ga3b498ec4aac4ec632f35c4109d372d69" title="Enable detect interrupt.">INT_ENERGY</a>)
<a name="l00159"></a>00159   {
<a name="l00160"></a>00160     <span class="comment">/* Clear RX of a Energy Interrupt flag */</span>
<a name="l00161"></a>00161     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00162"></a>00162     data = INT_ENERGY;
<a name="l00163"></a>00163     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00164"></a>00164     found_INT |= INT_ENERGY;
<a name="l00165"></a>00165   }
<a name="l00166"></a>00166   <span class="comment">/* Resolve the SPI Error interrupt */</span>
<a name="l00167"></a>00167   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#ga52cfee0a592e92976a61416dfec1a035" title="Enable receive SPI bus error interrupt.">INT_SPI_ERROR</a>)
<a name="l00168"></a>00168   {
<a name="l00169"></a>00169     <span class="comment">/* Clear SPI Error Interrupt flag */</span>
<a name="l00170"></a>00170     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00171"></a>00171     data = INT_SPI_ERROR;
<a name="l00172"></a>00172     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00173"></a>00173     found_INT |= INT_SPI_ERROR;
<a name="l00174"></a>00174   }
<a name="l00175"></a>00175   <span class="comment">/* Resolve the TX space interrupt */</span>
<a name="l00176"></a>00176   <span class="keywordflow">if</span> (ISR_stat &amp; <a class="code" href="group__ksz8851snl.html#gaa3a4e4b0b7fa2589e897b2d9f15ad9ea" title="Enable transmit space available interrupt.">INT_TX_SPACE</a>)
<a name="l00177"></a>00177   {
<a name="l00178"></a>00178     <span class="comment">/* Clear TX space Interrupt flag */</span>
<a name="l00179"></a>00179     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00180"></a>00180     data = INT_TX_SPACE;
<a name="l00181"></a>00181     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00182"></a>00182     found_INT |= INT_TX_SPACE;
<a name="l00183"></a>00183   }
<a name="l00184"></a>00184   <span class="keywordflow">return</span> found_INT;
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 <span class="comment">/***************************************************************************/</span>
<a name="l00195"></a><a class="code" href="group__ksz8851snl.html#gacadee7e36e356e75f01cabc3cd32be59">00195</a> uint16_t <a class="code" href="group__ksz8851snl.html#gacadee7e36e356e75f01cabc3cd32be59" title="Returns the size of the currently received frame.">KSZ8851SNL_CurrFrameSize</a>(<span class="keywordtype">void</span>)
<a name="l00196"></a>00196 {
<a name="l00197"></a>00197   uint16_t data;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199   <span class="comment">/* Read the byte size of the received frame */</span>
<a name="l00200"></a>00200   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga05e7b3e4b51a550924f288853f8fff71" title="Receive Frame Header Bytecount Register.">RX_FRH_BC_REG</a>, 2, &amp;data);
<a name="l00201"></a>00201 
<a name="l00202"></a>00202   data &amp;= <a class="code" href="group__ksz8851snl.html#ga60cd22a6881b225ea028f8bc1a0e0783" title="Used to mask the reserved bits.">RX_BYTE_CNT_MASK</a>;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204   <span class="keywordflow">return</span> data;
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="comment">/***************************************************************************/</span>
<a name="l00217"></a><a class="code" href="ksz8851snl_8c.html#a77477ac338cf16f8a8c76426cddafe08">00217</a> <span class="keyword">static</span> uint8_t <a class="code" href="ksz8851snl_8c.html#a77477ac338cf16f8a8c76426cddafe08" title="Returns the difference in bytes to be DWORD alligned.">KSZ8851SNL_DwordAllignDiff</a>(uint8_t val)
<a name="l00218"></a>00218 {
<a name="l00219"></a>00219   <span class="keywordflow">if</span> (val % 4 == 0) <span class="keywordflow">return</span> 0;
<a name="l00220"></a>00220   <span class="keywordflow">else</span> <span class="keywordflow">return</span> val % 4;
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 <span class="comment">/***************************************************************************/</span>
<a name="l00234"></a><a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc">00234</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc" title="Prints a message with a predetermined exception level Support method used for debugging...">KSZ8851SNL_ExceptionHandler</a>(<span class="keyword">enum</span> <a class="code" href="group__ksz8851snl.html#gae706783edc2cc1b3a192bd17946cad46" title="enumeration used for exception handling">exceptionType_e</a> exc_type, <span class="keywordtype">char</span>* param)
<a name="l00235"></a>00235 {
<a name="l00236"></a>00236   uint16_t data;
<a name="l00237"></a>00237   (void)param; <span class="comment">/* unused param */</span>
<a name="l00238"></a>00238   <span class="comment">/* Disable interupts on KSZ8851SNL */</span>
<a name="l00239"></a>00239   data = <a class="code" href="group__ksz8851snl.html#ga359afd6937727dbe8deee27136244dde" title="Used to disable the interupts.">NO_INT</a>;
<a name="l00240"></a>00240   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00241"></a>00241   <span class="keywordflow">switch</span> (exc_type)
<a name="l00242"></a>00242   {
<a name="l00243"></a>00243   <span class="keywordflow">case</span> ERROR:
<a name="l00244"></a>00244     <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;ERROR:%s\n&quot;</span>, param);
<a name="l00245"></a>00245     <span class="keywordflow">while</span> (1) ;
<a name="l00246"></a>00246   <span class="keywordflow">case</span> INFO:
<a name="l00247"></a>00247     <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;INFO:%s\n&quot;</span>, param);
<a name="l00248"></a>00248     <span class="keywordflow">break</span>;
<a name="l00249"></a>00249   }
<a name="l00250"></a>00250   <span class="comment">/* Enable interupts */</span>
<a name="l00251"></a>00251   data = <a class="code" href="group__ksz8851snl.html#ga1f20727c5c478956c891fb9919bdf338" title="Interrupt mask initialization collection.">INT_MASK_EXAMPLE</a>;
<a name="l00252"></a>00252   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="comment">/***************************************************************************/</span>
<a name="l00264"></a><a class="code" href="group__ksz8851snl.html#ga331546fa292db2b848dbddb76eaba7df">00264</a> <span class="keywordtype">void</span> <a class="code" href="group__ksz8851snl.html#ga331546fa292db2b848dbddb76eaba7df" title="Dumps the Management Information Base Counters.">KSZ8851SNL_ReadMIBCounters</a>(<span class="keywordtype">char</span>* param)
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266   EFM_ASSERT(param != NULL);
<a name="l00267"></a>00267   uint16_t data, dataLow, dataHigh;
<a name="l00268"></a>00268   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;#################################################################\n&quot;</span>);
<a name="l00269"></a>00269   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Dumping MIB Counters values @%s\n&quot;</span>, param);
<a name="l00270"></a>00270   <span class="keywordtype">int</span> i;
<a name="l00271"></a>00271   <span class="keywordflow">for</span> (i = 0; i &lt; 0x20; i++)
<a name="l00272"></a>00272   {
<a name="l00273"></a>00273     data = <a class="code" href="group__ksz8851snl.html#ga20ca27dd1f0d0a4b0f8f2d7fc68b9a67" title="MIB Mask.">MIB_MASK</a> | i;
<a name="l00274"></a>00274     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gac9e406b62ee75d476f70ec3c435eae70" title="Indirect access control Register.">IND_ACC_CTRL_REG</a>, 2, &amp;data);
<a name="l00275"></a>00275     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga989f1688d1c5149dc0deeec34ec3a0e5" title="Indirect access data low Register.">IND_ACC_DATA_LOW_REG</a>, 2, &amp;dataLow);
<a name="l00276"></a>00276     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga8c1ae3ffd5b38be82d8788f29e18b831" title="Indirect access data low Register.">IND_ACC_DATA_HIGH_REG</a>, 2, &amp;dataHigh);
<a name="l00277"></a>00277     <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;MIB_REG[%2X] contains %X - %X\n&quot;</span>, i, dataHigh, dataLow);
<a name="l00278"></a>00278   }
<a name="l00279"></a>00279   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;#################################################################\n&quot;</span>);
<a name="l00280"></a>00280 }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 
<a name="l00283"></a>00283 <span class="preprocessor">#if KSZ8851SNL_DEBUG</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span><span class="comment">/***************************************************************************/</span>
<a name="l00288"></a>00288 <span class="keyword">static</span> <span class="keywordtype">void</span> KSZ8851SNL_DumpRegisters(<span class="keywordtype">void</span>)
<a name="l00289"></a>00289 {
<a name="l00290"></a>00290   uint16_t data;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;#################################################################\n&quot;</span>);
<a name="l00293"></a>00293   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Dumping Register values\n&quot;</span>);
<a name="l00294"></a>00294 
<a name="l00295"></a>00295   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;#################################################################\n&quot;</span>);
<a name="l00296"></a>00296   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Dumping ALL Register values\n&quot;</span>);
<a name="l00297"></a>00297 
<a name="l00298"></a>00298   <span class="keywordtype">int</span> i;
<a name="l00299"></a>00299   <span class="keywordflow">for</span> (i = 0; = 0x00; i &lt; 0xFF; i += 0x02)
<a name="l00300"></a>00300   {
<a name="l00301"></a>00301     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(i, 2, &amp;data);
<a name="l00302"></a>00302     <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[0x%X] contains 0x%X\n&quot;</span>, i, data);
<a name="l00303"></a>00303   }
<a name="l00304"></a>00304   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;#################################################################\n&quot;</span>);
<a name="l00305"></a>00305   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;Dumping used registers values\n&quot;</span>);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga28aac5b994ede5c7c1f1c6b851b9498d" title="MAC Address Low.">LOW_QMU_MAC_REG</a>, 2, &amp;data);
<a name="l00308"></a>00308   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga28aac5b994ede5c7c1f1c6b851b9498d" title="MAC Address Low.">LOW_QMU_MAC_REG</a>, data);
<a name="l00309"></a>00309   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga9cadc20666f3e62c66a57cdac4ea1cee" title="MAC Address Middle.">MID_QMU_MAC_REG</a>, 2, &amp;data);
<a name="l00310"></a>00310   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga9cadc20666f3e62c66a57cdac4ea1cee" title="MAC Address Middle.">MID_QMU_MAC_REG</a>, data);
<a name="l00311"></a>00311   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gaccb7bc0b7cf2a4120efd3e78c7a4dbba" title="MAC Address High.">HIGH_QMU_MAC_REG</a>, 2, &amp;data);
<a name="l00312"></a>00312   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#gaccb7bc0b7cf2a4120efd3e78c7a4dbba" title="MAC Address High.">HIGH_QMU_MAC_REG</a>, data);
<a name="l00313"></a>00313   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga895a154d45c40d78a4edd04182cb8d2b" title="On-Chip Bus Control Register.">OBC_REG</a>, 2, &amp;data);
<a name="l00314"></a>00314   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga895a154d45c40d78a4edd04182cb8d2b" title="On-Chip Bus Control Register.">OBC_REG</a>, data);
<a name="l00315"></a>00315   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga68046bd02663c5a03ef2bafbda349e55" title="Global Reset Register.">GLOBAL_RESET_REG</a>, 2, &amp;data);
<a name="l00316"></a>00316   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga68046bd02663c5a03ef2bafbda349e55" title="Global Reset Register.">GLOBAL_RESET_REG</a>, data);
<a name="l00317"></a>00317   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gae698babe1cf93b0387cb1699ba557206" title="Transmit Flow Control Register.">TX_FLOW_CTRL_REG</a>, 2, &amp;data);
<a name="l00318"></a>00318   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#gae698babe1cf93b0387cb1699ba557206" title="Transmit Flow Control Register.">TX_FLOW_CTRL_REG</a>, data);
<a name="l00319"></a>00319   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga323ff2c33e9c0f78910b590c47c44ae9" title="Receive Flow Control Register 1.">RX_FLOW_CTRL1_REG</a>, 2, &amp;data);
<a name="l00320"></a>00320   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga323ff2c33e9c0f78910b590c47c44ae9" title="Receive Flow Control Register 1.">RX_FLOW_CTRL1_REG</a>, data);
<a name="l00321"></a>00321   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga6db6cb1e994aed2d21383115a8481332" title="Receive Flow Control Register 2.">RX_FLOW_CTRL2_REG</a>, 2, &amp;data);
<a name="l00322"></a>00322   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga6db6cb1e994aed2d21383115a8481332" title="Receive Flow Control Register 2.">RX_FLOW_CTRL2_REG</a>, data);
<a name="l00323"></a>00323   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gabf3e874bdd9286960e7b7c51f209d113" title="TXQ Memory Information Register.">TX_MEM_INFO_REG</a>, 2, &amp;data);
<a name="l00324"></a>00324   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#gabf3e874bdd9286960e7b7c51f209d113" title="TXQ Memory Information Register.">TX_MEM_INFO_REG</a>, data);
<a name="l00325"></a>00325   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gafbfe8d3f64212e7bda2413aab25c8b7f" title="Receive Frame Header Status Register.">RX_FRH_STAT_REG</a>, 2, &amp;data);
<a name="l00326"></a>00326   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#gafbfe8d3f64212e7bda2413aab25c8b7f" title="Receive Frame Header Status Register.">RX_FRH_STAT_REG</a>, data);
<a name="l00327"></a>00327   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00328"></a>00328   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, data);
<a name="l00329"></a>00329   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00330"></a>00330   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, data);
<a name="l00331"></a>00331   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga6733650651f6d09bcacb232449fa686d" title="TX Frame Data Pointer Register.">TX_FD_PTR_REG</a>, 2, &amp;data);
<a name="l00332"></a>00332   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga6733650651f6d09bcacb232449fa686d" title="TX Frame Data Pointer Register.">TX_FD_PTR_REG</a>, data);
<a name="l00333"></a>00333   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gaa6ad569f0f68a727c46f136f057c6436" title="RX Frame Data Pointer Register.">RX_FD_PTR_REG</a>, 2, &amp;data);
<a name="l00334"></a>00334   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#gaa6ad569f0f68a727c46f136f057c6436" title="RX Frame Data Pointer Register.">RX_FD_PTR_REG</a>, data);
<a name="l00335"></a>00335   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00336"></a>00336   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, data);
<a name="l00337"></a>00337   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00338"></a>00338   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, data);
<a name="l00339"></a>00339   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7813d31a11c56dece7ddd366c0fc8cda" title="RX Frame Count &amp;amp; Threshold Register.">RX_FRAME_THRES_REG</a>, 2, &amp;data);
<a name="l00340"></a>00340   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga7813d31a11c56dece7ddd366c0fc8cda" title="RX Frame Count &amp;amp; Threshold Register.">RX_FRAME_THRES_REG</a>, data);
<a name="l00341"></a>00341   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gabd2b59a84b873910e31204cbd55c05ca" title="TX Next Frame size register.">TX_NEXT_FRS_REG</a>, 2, &amp;data);
<a name="l00342"></a>00342   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#gabd2b59a84b873910e31204cbd55c05ca" title="TX Next Frame size register.">TX_NEXT_FRS_REG</a>, data);
<a name="l00343"></a>00343   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga36d39f4c958288cdb3050a94f9cf5e0c" title="Chip ID and Enable Register.">CIDER_REG</a>, 2, &amp;data);
<a name="l00344"></a>00344   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#ga36d39f4c958288cdb3050a94f9cf5e0c" title="Chip ID and Enable Register.">CIDER_REG</a>, data);
<a name="l00345"></a>00345   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbd4fd6ef1fcf365e0ab2302f6555453" title="PHY Reset Register.">PHY_RST_REG</a>, 2, &amp;data);
<a name="l00346"></a>00346   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#gacbd4fd6ef1fcf365e0ab2302f6555453" title="PHY Reset Register.">PHY_RST_REG</a>, data);
<a name="l00347"></a>00347   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gabde589971fba1de4265e49a589b144c1" title="PHY1 MII-Register Basic Control Register.">PHY1_CTRL_REG</a>, 2, &amp;data);
<a name="l00348"></a>00348   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#gabde589971fba1de4265e49a589b144c1" title="PHY1 MII-Register Basic Control Register.">PHY1_CTRL_REG</a>, data);
<a name="l00349"></a>00349   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gab8e5d58a904378c79676a33598a32027" title="Port 1 Control Register.">PORT1_CTRL_REG</a>, 2, &amp;data);
<a name="l00350"></a>00350   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;REG[%2X] contains %2X\n&quot;</span>, <a class="code" href="group__ksz8851snl.html#gab8e5d58a904378c79676a33598a32027" title="Port 1 Control Register.">PORT1_CTRL_REG</a>, data);
<a name="l00351"></a>00351   <a class="code" href="group__ksz8851snl.html#ga88edd2aa4feabff4af21a997d5d8aa23" title="DEBUG macro for printf function.">DEBUG_PRINT</a>(<span class="stringliteral">&quot;#################################################################\n&quot;</span>);
<a name="l00352"></a>00352 }
<a name="l00353"></a>00353 <span class="preprocessor">#endif </span><span class="comment">/* KSZ8851SNL_DEBUG */</span>
<a name="l00354"></a>00354 
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="comment">/***************************************************************************/</span>
<a name="l00359"></a><a class="code" href="group__ksz8851snl.html#ga414381cd961a77b97b9e17970ba43e7a">00359</a> <span class="keywordtype">void</span> <a class="code" href="group__ksz8851snl.html#ga414381cd961a77b97b9e17970ba43e7a" title="Initialize the registers of the ethernet controller.">KSZ8851SNL_Init</a>(<span class="keywordtype">void</span>)
<a name="l00360"></a>00360 {
<a name="l00361"></a>00361   uint16_t data;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363   <span class="comment">/* Initialize SPI Interface */</span>
<a name="l00364"></a>00364   <a class="code" href="group__EthSpi.html#gad514d1a84cda97d53d07cfaae13130eb" title="ETHSPI_Init Initialize SPI interface to Ethernet controller.">ETHSPI_Init</a>();
<a name="l00365"></a>00365 
<a name="l00366"></a>00366   <span class="comment">/* Reset Soft (clear registers of PHY, MAC, QMU, DMA) */</span>
<a name="l00367"></a>00367   data = <a class="code" href="group__ksz8851snl.html#ga4286160ca194bc8850c7fc9013fe3779" title="Global reset.">GLOBAL_SOFT_RESET</a>;
<a name="l00368"></a>00368   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga68046bd02663c5a03ef2bafbda349e55" title="Global Reset Register.">GLOBAL_RESET_REG</a>, 2, &amp;data);
<a name="l00369"></a>00369   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga68046bd02663c5a03ef2bafbda349e55" title="Global Reset Register.">GLOBAL_RESET_REG</a>, 2, &amp;data);
<a name="l00370"></a>00370   data &amp;= ~<a class="code" href="group__ksz8851snl.html#ga4286160ca194bc8850c7fc9013fe3779" title="Global reset.">GLOBAL_SOFT_RESET</a>;
<a name="l00371"></a>00371   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga68046bd02663c5a03ef2bafbda349e55" title="Global Reset Register.">GLOBAL_RESET_REG</a>, 2, &amp;data);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <span class="comment">/* Reset QMU Modules(flush out TXQ and RXQ) */</span>
<a name="l00374"></a>00374   data = <a class="code" href="group__ksz8851snl.html#gae208507c34e08e32bccb9a392c803d4b" title="QMU Reset.">QMU_MODULE_SOFT_RESET</a>;
<a name="l00375"></a>00375   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga68046bd02663c5a03ef2bafbda349e55" title="Global Reset Register.">GLOBAL_RESET_REG</a>, 2, &amp;data);
<a name="l00376"></a>00376   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga68046bd02663c5a03ef2bafbda349e55" title="Global Reset Register.">GLOBAL_RESET_REG</a>, 2, &amp;data);
<a name="l00377"></a>00377   data &amp;= ~<a class="code" href="group__ksz8851snl.html#gae208507c34e08e32bccb9a392c803d4b" title="QMU Reset.">QMU_MODULE_SOFT_RESET</a>;
<a name="l00378"></a>00378   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga68046bd02663c5a03ef2bafbda349e55" title="Global Reset Register.">GLOBAL_RESET_REG</a>, 2, &amp;data);
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 <span class="preprocessor">#ifdef DIGITAL_PHY_LOOPBACK</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>  KSZ8851SNL_SetDigitalLoopbackMode();
<a name="l00382"></a>00382 <span class="preprocessor">#endif </span><span class="comment">/* DIGITAL_PHY_LOOPBACK */</span>
<a name="l00383"></a>00383 
<a name="l00384"></a>00384   <span class="comment">/* Read the chip ID and check if that is correct */</span>
<a name="l00385"></a>00385   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga36d39f4c958288cdb3050a94f9cf5e0c" title="Chip ID and Enable Register.">CIDER_REG</a>, 2, &amp;data);
<a name="l00386"></a>00386 
<a name="l00387"></a>00387   <span class="comment">/* The CIDER lower bits [3..1] are defined as revision number,</span>
<a name="l00388"></a>00388 <span class="comment">   *   thus a mask needs to be applied</span>
<a name="l00389"></a>00389 <span class="comment">   */</span>
<a name="l00390"></a>00390   <span class="keywordflow">if</span> ((data &amp; <a class="code" href="group__ksz8851snl.html#ga71ef81afb42a9b3dc69b8efb67ba08cc" title="Used to mask the revision ID.">CHIP_ID_MASK</a>) != <a class="code" href="group__ksz8851snl.html#ga67a9f9d1d59c17889c587973b758890c" title="Default Chip ID for KSZ8851SNL.">KSZ8851SNL_CHIP_ID</a>)
<a name="l00391"></a>00391   {
<a name="l00392"></a>00392     <a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc" title="Prints a message with a predetermined exception level Support method used for debugging...">KSZ8851SNL_ExceptionHandler</a>(ERROR, <span class="stringliteral">&quot;ETH: Incorrect Device ID&quot;</span>);
<a name="l00393"></a>00393   }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395   <span class="comment">/* Write the Queue Management Unit MAC Address */</span>
<a name="l00396"></a>00396   <a class="code" href="group__ksz8851snl.html#gacbdbe4a02c390b610787f7913b6d183c" title="Get the MAC address of the current board.">KSZ8851SNL_GetMacAddress</a>(macAddress);
<a name="l00397"></a>00397   <span class="comment">/* Write the appropriate KSZ8851SNL MAC registers</span>
<a name="l00398"></a>00398 <span class="comment">   *   starting from the HIGH part towards the lower one</span>
<a name="l00399"></a>00399 <span class="comment">   *   going with a step of 2</span>
<a name="l00400"></a>00400 <span class="comment">   */</span>
<a name="l00401"></a>00401   <span class="keywordtype">int</span> i;
<a name="l00402"></a>00402   <span class="keywordflow">for</span> (i = 0; (i &lt; 6); i += 2)
<a name="l00403"></a>00403   {
<a name="l00404"></a>00404     data = (macAddress[i] &lt;&lt; <a class="code" href="group__ksz8851snl.html#gaebafa824e034291924298c85bc366e0e" title="Used to mark the MSB pos.">MSB_POS</a>) | macAddress[i + 1];
<a name="l00405"></a>00405     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gaccb7bc0b7cf2a4120efd3e78c7a4dbba" title="MAC Address High.">HIGH_QMU_MAC_REG</a> - i, 2, &amp;data);
<a name="l00406"></a>00406   }
<a name="l00407"></a>00407 
<a name="l00408"></a>00408   <span class="comment">/* Enable QMU Transmit Frame Data Pointer Auto Increment */</span>
<a name="l00409"></a>00409   data = <a class="code" href="group__ksz8851snl.html#ga56cdd36751f5a5ba51247720848a46ae" title="Used to reset the FD pointer.">FD_PTR_AUTO_INC</a>;
<a name="l00410"></a>00410   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga6733650651f6d09bcacb232449fa686d" title="TX Frame Data Pointer Register.">TX_FD_PTR_REG</a>, 2, &amp;data);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412   <span class="comment">/* FLUSH TX queue */</span>
<a name="l00413"></a>00413   data |= <a class="code" href="group__ksz8851snl.html#ga834364c5d577e607cd80192eb19610ac" title="Flush Transmit Queue.">TX_FLOW_CTRL_FLUSH_QUEUE</a>;
<a name="l00414"></a>00414   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gae698babe1cf93b0387cb1699ba557206" title="Transmit Flow Control Register.">TX_FLOW_CTRL_REG</a>, 2, &amp;data);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416   <span class="comment">/* Enable QMU Transmit:</span>
<a name="l00417"></a>00417 <span class="comment">   *  flow control,</span>
<a name="l00418"></a>00418 <span class="comment">   *  padding,</span>
<a name="l00419"></a>00419 <span class="comment">   *  CRC,</span>
<a name="l00420"></a>00420 <span class="comment">   *  IP/TCP/UDP/ICMP checksum generation.</span>
<a name="l00421"></a>00421 <span class="comment">   */</span>
<a name="l00422"></a>00422   data = <a class="code" href="group__ksz8851snl.html#gabee3f441d58bb64ccd6b6f83dd6717c5" title="TX FLOW CONTROL Initialization collection.">TX_FLOW_CTRL_EXAMPLE</a>;
<a name="l00423"></a>00423   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gae698babe1cf93b0387cb1699ba557206" title="Transmit Flow Control Register.">TX_FLOW_CTRL_REG</a>, 2, &amp;data);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425   <span class="comment">/* Enable QMU Receive Frame Data Pointer Auto Increment */</span>
<a name="l00426"></a>00426   data = <a class="code" href="group__ksz8851snl.html#ga56cdd36751f5a5ba51247720848a46ae" title="Used to reset the FD pointer.">FD_PTR_AUTO_INC</a>;
<a name="l00427"></a>00427   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gaa6ad569f0f68a727c46f136f057c6436" title="RX Frame Data Pointer Register.">RX_FD_PTR_REG</a>, 2, &amp;data);
<a name="l00428"></a>00428 
<a name="l00429"></a>00429   <span class="comment">/* Configure Receive Frame Threshold for one frame */</span>
<a name="l00430"></a>00430   data = <a class="code" href="group__ksz8851snl.html#ga0189fe248f84298f9ccffd38692604fb" title="RX INT after one frame.">ONE_FRAME_THRES</a>;
<a name="l00431"></a>00431   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7813d31a11c56dece7ddd366c0fc8cda" title="RX Frame Count &amp;amp; Threshold Register.">RX_FRAME_THRES_REG</a>, 2, &amp;data);
<a name="l00432"></a>00432 
<a name="l00433"></a>00433   <span class="comment">/* Enable QMU Receive:</span>
<a name="l00434"></a>00434 <span class="comment">   *  flow control,</span>
<a name="l00435"></a>00435 <span class="comment">   *  receive all broadcast frame,</span>
<a name="l00436"></a>00436 <span class="comment">   *  receive unicast frame,</span>
<a name="l00437"></a>00437 <span class="comment">   *  IP/TCP/UDP/ICMP checksum generation.</span>
<a name="l00438"></a>00438 <span class="comment">   */</span>
<a name="l00439"></a>00439   data = <a class="code" href="group__ksz8851snl.html#ga5bfefaad4fe0cdd024bc970ad1c89a86" title="RX FLOW CONTROL1 Initialization collection.">RX_FLOW_CTRL1_EXAMPLE</a>;
<a name="l00440"></a>00440   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga323ff2c33e9c0f78910b590c47c44ae9" title="Receive Flow Control Register 1.">RX_FLOW_CTRL1_REG</a>, 2, &amp;data);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442   <span class="comment">/* Enable QMU Receive:</span>
<a name="l00443"></a>00443 <span class="comment">   *  ICMP/UDP Lite frame checksum verification,</span>
<a name="l00444"></a>00444 <span class="comment">   *  UDP Lite frame checksum generation,</span>
<a name="l00445"></a>00445 <span class="comment">   *  IPv6 UDP fragment frame pass.</span>
<a name="l00446"></a>00446 <span class="comment">   */</span>
<a name="l00447"></a>00447   data = <a class="code" href="group__ksz8851snl.html#ga4237a6788df2cf050f6475c039b4c1f9" title="RX FLOW CONTROL2 Initialization collection.">RX_FLOW_CTRL2_EXAMPLE</a>;
<a name="l00448"></a>00448   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga6db6cb1e994aed2d21383115a8481332" title="Receive Flow Control Register 2.">RX_FLOW_CTRL2_REG</a>, 2, &amp;data);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450   <span class="comment">/* Enable QMU Receive:</span>
<a name="l00451"></a>00451 <span class="comment">   *  IP Header Two-Byte Offset,</span>
<a name="l00452"></a>00452 <span class="comment">   *  Receive Frame Count Threshold,</span>
<a name="l00453"></a>00453 <span class="comment">   *  RXQ Auto-Dequeue frame.</span>
<a name="l00454"></a>00454 <span class="comment">   */</span>
<a name="l00455"></a>00455   data = <a class="code" href="group__ksz8851snl.html#ga6d2b7e049e9ed45fb14f0d65deabf1ca" title="RX COMMAND Initialization collection.">RXQ_CMD_EXAMPLE</a>;
<a name="l00456"></a>00456   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00457"></a>00457 
<a name="l00458"></a>00458   <span class="comment">/* Restart Port 1 auto-negotiation */</span>
<a name="l00459"></a>00459   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gab8e5d58a904378c79676a33598a32027" title="Port 1 Control Register.">PORT1_CTRL_REG</a>, 2, &amp;data);
<a name="l00460"></a>00460   data |= <a class="code" href="group__ksz8851snl.html#gafefbc2ee026e2c62da2f3540a11d943d" title="Restart auto-negotiation.">PORT1_AUTO_NEG_RESTART</a>;
<a name="l00461"></a>00461   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gab8e5d58a904378c79676a33598a32027" title="Port 1 Control Register.">PORT1_CTRL_REG</a>, 2, &amp;data);
<a name="l00462"></a>00462 
<a name="l00463"></a>00463   <span class="comment">/* Force link in half duplex if auto-negotiation failed  */</span>
<a name="l00464"></a>00464   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gab8e5d58a904378c79676a33598a32027" title="Port 1 Control Register.">PORT1_CTRL_REG</a>, 2, &amp;data);
<a name="l00465"></a>00465   <span class="keywordflow">if</span> ((data &amp; <a class="code" href="group__ksz8851snl.html#gafefbc2ee026e2c62da2f3540a11d943d" title="Restart auto-negotiation.">PORT1_AUTO_NEG_RESTART</a>) != PORT1_AUTO_NEG_RESTART)
<a name="l00466"></a>00466   {
<a name="l00467"></a>00467     data &amp;= ~<a class="code" href="group__ksz8851snl.html#gaa76726ee8bc368c225c7052ac8d215c1" title="Force PHY in full duplex mode.">PORT1_FORCE_FULL_DUPLEX</a>;
<a name="l00468"></a>00468     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gab8e5d58a904378c79676a33598a32027" title="Port 1 Control Register.">PORT1_CTRL_REG</a>, 2, &amp;data);
<a name="l00469"></a>00469   }
<a name="l00470"></a>00470   <span class="comment">/* Configure Low Watermark to 6KByte available buffer space out of 12KByte */</span>
<a name="l00471"></a>00471   data = <a class="code" href="group__ksz8851snl.html#gace67331af9e371dffde22d1b5fabf5f1" title="6KByte Watermark">WATERMARK_6KB</a>;
<a name="l00472"></a>00472   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga1c35b4820ee16cd98cf3e16dc570b383" title="Configure Low Watermark to 6KByte.">FLOW_CTRL_LOW_WATERMARK</a>, 2, &amp;data);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474   <span class="comment">/* Configure High Watermark to 4KByte available buffer space out of 12KByte */</span>
<a name="l00475"></a>00475   data = <a class="code" href="group__ksz8851snl.html#gae78ae160bdcc753d7ecd0c42c8d0c49b" title="4KByte Watermark">WATERMARK_4KB</a>;
<a name="l00476"></a>00476   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga5c9f98d4f0b18dbdc20c192d34503669" title="Configure High Watermark to 4KByte.">FLOW_CTRL_HIGH_WATERMARK</a>, 2, &amp;data);
<a name="l00477"></a>00477 
<a name="l00478"></a>00478   <span class="comment">/* Clear the interrupts status */</span>
<a name="l00479"></a>00479   data = <a class="code" href="group__ksz8851snl.html#gac83b32831e0638f88b91366948124c04" title="Used to clear INT_STATUS_REG.">CLEAR_INT</a>;
<a name="l00480"></a>00480   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00481"></a>00481 
<a name="l00482"></a>00482   <span class="comment">/* Enable Interrupts on:</span>
<a name="l00483"></a>00483 <span class="comment">   *  Link Change</span>
<a name="l00484"></a>00484 <span class="comment">   *  Transmit</span>
<a name="l00485"></a>00485 <span class="comment">   *  Receive</span>
<a name="l00486"></a>00486 <span class="comment">   *  Receive Overrun</span>
<a name="l00487"></a>00487 <span class="comment">   *  Transmit Process Stop</span>
<a name="l00488"></a>00488 <span class="comment">   *  Receive Process Stop</span>
<a name="l00489"></a>00489 <span class="comment">   */</span>
<a name="l00490"></a>00490   data = <a class="code" href="group__ksz8851snl.html#ga1f20727c5c478956c891fb9919bdf338" title="Interrupt mask initialization collection.">INT_MASK_EXAMPLE</a>;
<a name="l00491"></a>00491   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493   <span class="comment">/* Enable QMU Transmit */</span>
<a name="l00494"></a>00494   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gae698babe1cf93b0387cb1699ba557206" title="Transmit Flow Control Register.">TX_FLOW_CTRL_REG</a>, 2, &amp;data);
<a name="l00495"></a>00495   data |= <a class="code" href="group__ksz8851snl.html#ga4fb198f5122ad90b21a55144fd193adc" title="Enable tranmsit.">TX_FLOW_CTRL_ENABLE</a>;
<a name="l00496"></a>00496   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gae698babe1cf93b0387cb1699ba557206" title="Transmit Flow Control Register.">TX_FLOW_CTRL_REG</a>, 2, &amp;data);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498   <span class="comment">/* Enable QMU Receive */</span>
<a name="l00499"></a>00499   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga323ff2c33e9c0f78910b590c47c44ae9" title="Receive Flow Control Register 1.">RX_FLOW_CTRL1_REG</a>, 2, &amp;data);
<a name="l00500"></a>00500   data |= <a class="code" href="group__ksz8851snl.html#ga72745933ac36118d949502d6997f747d" title="Enable receive.">RX_FLOW_CTRL_ENABLE</a>;
<a name="l00501"></a>00501   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga323ff2c33e9c0f78910b590c47c44ae9" title="Receive Flow Control Register 1.">RX_FLOW_CTRL1_REG</a>, 2, &amp;data);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503   <a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc" title="Prints a message with a predetermined exception level Support method used for debugging...">KSZ8851SNL_ExceptionHandler</a>(INFO, <span class="stringliteral">&quot;ETH: Initialization complete&quot;</span>);
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 <span class="comment">/***************************************************************************/</span>
<a name="l00515"></a><a class="code" href="group__ksz8851snl.html#ga8329c1bba6f93078d9b91097b8e74ec6">00515</a> <span class="keywordtype">void</span> <a class="code" href="group__ksz8851snl.html#ga8329c1bba6f93078d9b91097b8e74ec6" title="Performs the actual transmit of a raw frame over the network.">KSZ8851SNL_Send</a>(uint16_t pTXLength, uint8_t *pTXData)
<a name="l00516"></a>00516 {
<a name="l00517"></a>00517   EFM_ASSERT(pTXData != NULL);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519   uint16_t txmir;
<a name="l00520"></a>00520   uint16_t data, reqSize;
<a name="l00521"></a>00521   uint8_t  outbuf[4];
<a name="l00522"></a>00522 
<a name="l00523"></a>00523   <span class="comment">/* Check if TXQ has enough memory for the transmission of the package */</span>
<a name="l00524"></a>00524   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gabf3e874bdd9286960e7b7c51f209d113" title="TXQ Memory Information Register.">TX_MEM_INFO_REG</a>, 2, &amp;data);
<a name="l00525"></a>00525   txmir = data &amp; <a class="code" href="group__ksz8851snl.html#gad53a856610ae8f92071467aa1d9f0215" title="Used to mask the reserved bits.">TX_MEM_AVAIL_MASK</a>;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527   reqSize = pTXLength + <a class="code" href="group__ksz8851snl.html#ga14310221be58e5b64cc335aaecc80afd" title="Needed for the frame header.">EXTRA_SIZE</a>;
<a name="l00528"></a>00528   <span class="keywordflow">if</span> (txmir &lt; reqSize)
<a name="l00529"></a>00529   {
<a name="l00530"></a>00530     <a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc" title="Prints a message with a predetermined exception level Support method used for debugging...">KSZ8851SNL_ExceptionHandler</a>(INFO, <span class="stringliteral">&quot;I will wait until mem is available\n&quot;</span>);
<a name="l00531"></a>00531     <span class="comment">/* Enable TX memory available monitor */</span>
<a name="l00532"></a>00532     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gabd2b59a84b873910e31204cbd55c05ca" title="TX Next Frame size register.">TX_NEXT_FRS_REG</a>, 2, &amp;reqSize);
<a name="l00533"></a>00533     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00534"></a>00534     data |= <a class="code" href="group__ksz8851snl.html#gaef4013e1ace29d2d23b001d710b03b7a" title="Enable INT generation when TXQ Memory Available.">TXQ_MEM_AVAILABLE_INT</a>;
<a name="l00535"></a>00535     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     <span class="comment">/* Wait until enough space is available */</span>
<a name="l00538"></a>00538     <span class="keywordflow">while</span> (1)
<a name="l00539"></a>00539     {
<a name="l00540"></a>00540       <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00541"></a>00541       <span class="keywordflow">if</span> ((data &amp; <a class="code" href="group__ksz8851snl.html#gaa3a4e4b0b7fa2589e897b2d9f15ad9ea" title="Enable transmit space available interrupt.">INT_TX_SPACE</a>) == INT_TX_SPACE)
<a name="l00542"></a>00542       {
<a name="l00543"></a>00543         <span class="keywordflow">break</span>;
<a name="l00544"></a>00544       }
<a name="l00545"></a>00545     }
<a name="l00546"></a>00546     <a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc" title="Prints a message with a predetermined exception level Support method used for debugging...">KSZ8851SNL_ExceptionHandler</a>(INFO, <span class="stringliteral">&quot;Done\n&quot;</span>);
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <span class="comment">/* Clear flag */</span>
<a name="l00549"></a>00549     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00550"></a>00550     data &amp;= ~<a class="code" href="group__ksz8851snl.html#gaa3a4e4b0b7fa2589e897b2d9f15ad9ea" title="Enable transmit space available interrupt.">INT_TX_SPACE</a>;
<a name="l00551"></a>00551     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00552"></a>00552   }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554   <span class="comment">/* Disable interupts on KSZ8851SNL */</span>
<a name="l00555"></a>00555   data = <a class="code" href="group__ksz8851snl.html#ga359afd6937727dbe8deee27136244dde" title="Used to disable the interupts.">NO_INT</a>;
<a name="l00556"></a>00556   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558   <span class="comment">/* Enable TXQ write access */</span>
<a name="l00559"></a>00559   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00560"></a>00560   data |= <a class="code" href="group__ksz8851snl.html#gad6f57d490fb0b52fbd122d4664c9592f" title="Start QMU transfer operation.">RXQ_START</a>;
<a name="l00561"></a>00561   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00562"></a>00562 
<a name="l00563"></a>00563   <span class="comment">/* Write frame ID, control word and byte count */</span>
<a name="l00564"></a>00564   outbuf[0] = (frameId++ &amp; <a class="code" href="group__ksz8851snl.html#ga4a92eca31055e7da3c5be2150c0aece5" title="Used to mask the reserved bits.">frameId_MASK</a>) | <a class="code" href="group__ksz8851snl.html#gaedbede564fb262aa18cf51017de948ae" title="TX INT on completion.">TX_INT_on_COMPLETION</a>;
<a name="l00565"></a>00565   outbuf[1] = 0;
<a name="l00566"></a>00566   outbuf[2] = pTXLength &amp; <a class="code" href="group__ksz8851snl.html#ga338d54179ac0da2af2363e3a930bf374" title="Used to mask the LSB.">LSB_MASK</a>;
<a name="l00567"></a>00567   outbuf[3] = pTXLength &gt;&gt; <a class="code" href="group__ksz8851snl.html#gaebafa824e034291924298c85bc366e0e" title="Used to mark the MSB pos.">MSB_POS</a>;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569   <span class="comment">/* Start the SPI Transfer */</span>
<a name="l00570"></a>00570   <a class="code" href="group__EthSpi.html#gad65430a9da918766b0647e72b6de40ec" title="Start writing to the ethernet controller FIFO.">ETHSPI_StartWriteFIFO</a>();
<a name="l00571"></a>00571   <span class="comment">/* Send the frame header info */</span>
<a name="l00572"></a>00572   <a class="code" href="group__EthSpi.html#ga89c3879ab639b3ad71262f9b31f74dfb" title="Continue writing ethernet controller FIFO.">ETHSPI_WriteFifoContinue</a>(4, outbuf);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574   <span class="comment">/* Send the actual data */</span>
<a name="l00575"></a>00575   <a class="code" href="group__EthSpi.html#ga89c3879ab639b3ad71262f9b31f74dfb" title="Continue writing ethernet controller FIFO.">ETHSPI_WriteFifoContinue</a>(pTXLength, pTXData);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577   <span class="comment">/* Send dummy bytes to align data to DWORD */</span>
<a name="l00578"></a>00578   <a class="code" href="group__EthSpi.html#ga89c3879ab639b3ad71262f9b31f74dfb" title="Continue writing ethernet controller FIFO.">ETHSPI_WriteFifoContinue</a>(<a class="code" href="ksz8851snl_8c.html#a77477ac338cf16f8a8c76426cddafe08" title="Returns the difference in bytes to be DWORD alligned.">KSZ8851SNL_DwordAllignDiff</a>(pTXLength), pTXData);
<a name="l00579"></a>00579 
<a name="l00580"></a>00580   <span class="comment">/* Stop the SPI Transfer */</span>
<a name="l00581"></a>00581   <a class="code" href="group__EthSpi.html#ga0d7054f02bb0f76d2aae18ead51398da" title="Stop read/write the ethernet controller FIFO.">ETHSPI_StopFIFO</a>();
<a name="l00582"></a>00582 
<a name="l00583"></a>00583   <span class="comment">/* Disable TXQ write access */</span>
<a name="l00584"></a>00584   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00585"></a>00585   data &amp;= ~<a class="code" href="group__ksz8851snl.html#gad6f57d490fb0b52fbd122d4664c9592f" title="Start QMU transfer operation.">RXQ_START</a>;
<a name="l00586"></a>00586   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588   <span class="comment">/* Start TXQ Manual Engue */</span>
<a name="l00589"></a>00589   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00590"></a>00590   data |= <a class="code" href="group__ksz8851snl.html#ga56ad1b68495eb52699727a5e1fd29da5" title="Enable Manual Engueue TXQ Frame.">TXQ_ENQUEUE</a>;
<a name="l00591"></a>00591   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00592"></a>00592 
<a name="l00593"></a>00593   <span class="comment">/* Wait until transmit command clears */</span>
<a name="l00594"></a>00594   <span class="keywordflow">while</span> (1)
<a name="l00595"></a>00595   {
<a name="l00596"></a>00596     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00597"></a>00597     <span class="keywordflow">if</span> (!(data &amp; <a class="code" href="group__ksz8851snl.html#ga56ad1b68495eb52699727a5e1fd29da5" title="Enable Manual Engueue TXQ Frame.">TXQ_ENQUEUE</a>))
<a name="l00598"></a>00598       <span class="keywordflow">break</span>;
<a name="l00599"></a>00599   }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601   <span class="comment">/* Enable interupts */</span>
<a name="l00602"></a>00602   data = <a class="code" href="group__ksz8851snl.html#ga1f20727c5c478956c891fb9919bdf338" title="Interrupt mask initialization collection.">INT_MASK_EXAMPLE</a>;
<a name="l00603"></a>00603   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00604"></a>00604 }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 <span class="comment">/***************************************************************************/</span>
<a name="l00614"></a><a class="code" href="group__ksz8851snl.html#ga724ea000fa4b7647888f74c72789a2c7">00614</a> <span class="keywordtype">void</span> <a class="code" href="group__ksz8851snl.html#ga724ea000fa4b7647888f74c72789a2c7" title="Performs the initialisation of the transmission of a long raw frame over the network...">KSZ8851SNL_InitiateLongTransmit</a>(uint16_t pTXLength)
<a name="l00615"></a>00615 {
<a name="l00616"></a>00616   uint16_t txmir;
<a name="l00617"></a>00617   uint16_t data, reqSize;
<a name="l00618"></a>00618   uint8_t  outbuf[4];
<a name="l00619"></a>00619 
<a name="l00620"></a>00620   <span class="comment">/* Check if TXQ has enough memory for the transmission of the package */</span>
<a name="l00621"></a>00621   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gabf3e874bdd9286960e7b7c51f209d113" title="TXQ Memory Information Register.">TX_MEM_INFO_REG</a>, 2, &amp;data);
<a name="l00622"></a>00622   txmir = data &amp; <a class="code" href="group__ksz8851snl.html#gad53a856610ae8f92071467aa1d9f0215" title="Used to mask the reserved bits.">TX_MEM_AVAIL_MASK</a>;
<a name="l00623"></a>00623 
<a name="l00624"></a>00624   reqSize = pTXLength + <a class="code" href="group__ksz8851snl.html#ga14310221be58e5b64cc335aaecc80afd" title="Needed for the frame header.">EXTRA_SIZE</a>;
<a name="l00625"></a>00625   <span class="keywordflow">if</span> (txmir &lt; reqSize)
<a name="l00626"></a>00626   {
<a name="l00627"></a>00627     <a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc" title="Prints a message with a predetermined exception level Support method used for debugging...">KSZ8851SNL_ExceptionHandler</a>(INFO, <span class="stringliteral">&quot;I will wait until mem is available\n&quot;</span>);
<a name="l00628"></a>00628     <span class="comment">/* Enable TX memory available monitor */</span>
<a name="l00629"></a>00629     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gabd2b59a84b873910e31204cbd55c05ca" title="TX Next Frame size register.">TX_NEXT_FRS_REG</a>, 2, &amp;reqSize);
<a name="l00630"></a>00630     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00631"></a>00631     data |= <a class="code" href="group__ksz8851snl.html#gaef4013e1ace29d2d23b001d710b03b7a" title="Enable INT generation when TXQ Memory Available.">TXQ_MEM_AVAILABLE_INT</a>;
<a name="l00632"></a>00632     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="comment">/* Wait until enough space is available */</span>
<a name="l00635"></a>00635     <span class="keywordflow">while</span> (1)
<a name="l00636"></a>00636     {
<a name="l00637"></a>00637       <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00638"></a>00638       <span class="keywordflow">if</span> ((data &amp; <a class="code" href="group__ksz8851snl.html#gaa3a4e4b0b7fa2589e897b2d9f15ad9ea" title="Enable transmit space available interrupt.">INT_TX_SPACE</a>) == INT_TX_SPACE)
<a name="l00639"></a>00639       {
<a name="l00640"></a>00640         <span class="keywordflow">break</span>;
<a name="l00641"></a>00641       }
<a name="l00642"></a>00642     }
<a name="l00643"></a>00643     <a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc" title="Prints a message with a predetermined exception level Support method used for debugging...">KSZ8851SNL_ExceptionHandler</a>(INFO, <span class="stringliteral">&quot;Done\n&quot;</span>);
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     <span class="comment">/* Clear flag */</span>
<a name="l00646"></a>00646     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00647"></a>00647     data &amp;= ~<a class="code" href="group__ksz8851snl.html#gaa3a4e4b0b7fa2589e897b2d9f15ad9ea" title="Enable transmit space available interrupt.">INT_TX_SPACE</a>;
<a name="l00648"></a>00648     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga78c88cee07608033e81cf808ce33f067" title="Interrupt Status Register.">INT_STATUS_REG</a>, 2, &amp;data);
<a name="l00649"></a>00649   }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651   <span class="comment">/* Disable interupts on KSZ8851SNL */</span>
<a name="l00652"></a>00652   data = <a class="code" href="group__ksz8851snl.html#ga359afd6937727dbe8deee27136244dde" title="Used to disable the interupts.">NO_INT</a>;
<a name="l00653"></a>00653   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00654"></a>00654 
<a name="l00655"></a>00655   <span class="comment">/* Enable TXQ write access */</span>
<a name="l00656"></a>00656   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00657"></a>00657   data |= <a class="code" href="group__ksz8851snl.html#gad6f57d490fb0b52fbd122d4664c9592f" title="Start QMU transfer operation.">RXQ_START</a>;
<a name="l00658"></a>00658   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00659"></a>00659 
<a name="l00660"></a>00660   <span class="comment">/* Write frame ID, control word and byte count */</span>
<a name="l00661"></a>00661   outbuf[0] = (frameId++ &amp; <a class="code" href="group__ksz8851snl.html#ga4a92eca31055e7da3c5be2150c0aece5" title="Used to mask the reserved bits.">frameId_MASK</a>) | <a class="code" href="group__ksz8851snl.html#gaedbede564fb262aa18cf51017de948ae" title="TX INT on completion.">TX_INT_on_COMPLETION</a>;
<a name="l00662"></a>00662   outbuf[1] = 0;
<a name="l00663"></a>00663   outbuf[2] = pTXLength &amp; <a class="code" href="group__ksz8851snl.html#ga338d54179ac0da2af2363e3a930bf374" title="Used to mask the LSB.">LSB_MASK</a>;
<a name="l00664"></a>00664   outbuf[3] = pTXLength &gt;&gt; <a class="code" href="group__ksz8851snl.html#gaebafa824e034291924298c85bc366e0e" title="Used to mark the MSB pos.">MSB_POS</a>;
<a name="l00665"></a>00665 
<a name="l00666"></a>00666   <span class="comment">/* Start the SPI Transfer */</span>
<a name="l00667"></a>00667   <a class="code" href="group__EthSpi.html#gad65430a9da918766b0647e72b6de40ec" title="Start writing to the ethernet controller FIFO.">ETHSPI_StartWriteFIFO</a>();
<a name="l00668"></a>00668   <span class="comment">/* Send the frame header info */</span>
<a name="l00669"></a>00669   <a class="code" href="group__EthSpi.html#ga89c3879ab639b3ad71262f9b31f74dfb" title="Continue writing ethernet controller FIFO.">ETHSPI_WriteFifoContinue</a>(4, outbuf);
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672 
<a name="l00673"></a>00673 <span class="comment">/***************************************************************************/</span>
<a name="l00681"></a><a class="code" href="group__ksz8851snl.html#ga5728561d0f839a3db3ffdf1483b79ba8">00681</a> <span class="keywordtype">void</span> <a class="code" href="group__ksz8851snl.html#ga5728561d0f839a3db3ffdf1483b79ba8" title="Performs the actual transmission of a long raw frame over the network.">KSZ8851SNL_LongTransmit</a>(uint16_t pTXLength, uint8_t *pTXData)
<a name="l00682"></a>00682 {
<a name="l00683"></a>00683   EFM_ASSERT(pTXData != NULL);
<a name="l00684"></a>00684   <span class="comment">/* Send the actual data */</span>
<a name="l00685"></a>00685   <a class="code" href="group__EthSpi.html#ga89c3879ab639b3ad71262f9b31f74dfb" title="Continue writing ethernet controller FIFO.">ETHSPI_WriteFifoContinue</a>(pTXLength, pTXData);
<a name="l00686"></a>00686 }
<a name="l00687"></a>00687 
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 <span class="comment">/***************************************************************************/</span>
<a name="l00698"></a><a class="code" href="group__ksz8851snl.html#gadc028066e15f60be50061cec4b9cd997">00698</a> <span class="keywordtype">void</span> <a class="code" href="group__ksz8851snl.html#gadc028066e15f60be50061cec4b9cd997" title="Performs the clean up procedures after the transmission of a long raw frame over...">KSZ8851SNL_TerminateLongTransmit</a>(uint16_t pTXLength, uint8_t *pTXData)
<a name="l00699"></a>00699 {
<a name="l00700"></a>00700   EFM_ASSERT(pTXData != NULL);
<a name="l00701"></a>00701 
<a name="l00702"></a>00702   uint16_t data;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704   <span class="comment">/* Send dummy bytes to align data to DWORD */</span>
<a name="l00705"></a>00705   <a class="code" href="group__EthSpi.html#ga89c3879ab639b3ad71262f9b31f74dfb" title="Continue writing ethernet controller FIFO.">ETHSPI_WriteFifoContinue</a>(<a class="code" href="ksz8851snl_8c.html#a77477ac338cf16f8a8c76426cddafe08" title="Returns the difference in bytes to be DWORD alligned.">KSZ8851SNL_DwordAllignDiff</a>(pTXLength), pTXData);
<a name="l00706"></a>00706 
<a name="l00707"></a>00707   <span class="comment">/* Stop the SPI Transfer */</span>
<a name="l00708"></a>00708   <a class="code" href="group__EthSpi.html#ga0d7054f02bb0f76d2aae18ead51398da" title="Stop read/write the ethernet controller FIFO.">ETHSPI_StopFIFO</a>();
<a name="l00709"></a>00709 
<a name="l00710"></a>00710   <span class="comment">/* Disable TXQ write access */</span>
<a name="l00711"></a>00711   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00712"></a>00712   data &amp;= ~<a class="code" href="group__ksz8851snl.html#gad6f57d490fb0b52fbd122d4664c9592f" title="Start QMU transfer operation.">RXQ_START</a>;
<a name="l00713"></a>00713   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00714"></a>00714 
<a name="l00715"></a>00715   <span class="comment">/* Start TXQ Manual Engue */</span>
<a name="l00716"></a>00716   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00717"></a>00717   data |= <a class="code" href="group__ksz8851snl.html#ga56ad1b68495eb52699727a5e1fd29da5" title="Enable Manual Engueue TXQ Frame.">TXQ_ENQUEUE</a>;
<a name="l00718"></a>00718   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00719"></a>00719 
<a name="l00720"></a>00720   <span class="comment">/* Wait until transmit command clears */</span>
<a name="l00721"></a>00721   <span class="keywordflow">while</span> (1)
<a name="l00722"></a>00722   {
<a name="l00723"></a>00723     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga73780e2c674f7f503d51e55ea359e2bf" title="TXQ Command Register.">TXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00724"></a>00724     <span class="keywordflow">if</span> (!(data &amp; <a class="code" href="group__ksz8851snl.html#ga56ad1b68495eb52699727a5e1fd29da5" title="Enable Manual Engueue TXQ Frame.">TXQ_ENQUEUE</a>))
<a name="l00725"></a>00725       <span class="keywordflow">break</span>;
<a name="l00726"></a>00726   }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   <span class="comment">/* Enable interupts */</span>
<a name="l00729"></a>00729   data = <a class="code" href="group__ksz8851snl.html#ga1f20727c5c478956c891fb9919bdf338" title="Interrupt mask initialization collection.">INT_MASK_EXAMPLE</a>;
<a name="l00730"></a>00730   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 <span class="comment">/***************************************************************************/</span>
<a name="l00738"></a><a class="code" href="ksz8851snl_8c.html#a92d3dd835f6bf9055f25702d288adbe6">00738</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="ksz8851snl_8c.html#a92d3dd835f6bf9055f25702d288adbe6" title="Realease the current frame if it is inconsistent.">KSZ8851SNL_ReleaseIncosistentFrame</a>(<span class="keywordtype">void</span>)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740   uint16_t data;
<a name="l00741"></a>00741   <span class="comment">/* Issue the Release error frame command */</span>
<a name="l00742"></a>00742   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00743"></a>00743   data |= <a class="code" href="group__ksz8851snl.html#ga44199e0b6b7e4fb150ae204e19de103c" title="Release RX Error Frame.">RXQ_RELEASE_CUR_FR</a>;
<a name="l00744"></a>00744   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00745"></a>00745   <a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc" title="Prints a message with a predetermined exception level Support method used for debugging...">KSZ8851SNL_ExceptionHandler</a>(INFO, <span class="stringliteral">&quot;The frame was inconsistent\n&quot;</span>);
<a name="l00746"></a>00746 }
<a name="l00747"></a>00747 
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 <span class="preprocessor">#if KSZ8851SNL_DEBUG</span>
<a name="l00750"></a>00750 <span class="preprocessor"></span><span class="comment">/***************************************************************************/</span>
<a name="l00754"></a>00754 <span class="keyword">static</span> <span class="keywordtype">void</span> KSZ8851SNL_SetDigitalLoopbackMode(<span class="keywordtype">void</span>)
<a name="l00755"></a>00755 {
<a name="l00756"></a>00756   uint16_t data;
<a name="l00757"></a>00757   <span class="comment">/* Reset PHY. */</span>
<a name="l00758"></a>00758   data = <a class="code" href="group__ksz8851snl.html#ga6f5048620b3dde8583f7f1118e9de187" title="PHY Reset Register Options.">PHY_RESET</a>;
<a name="l00759"></a>00759   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbd4fd6ef1fcf365e0ab2302f6555453" title="PHY Reset Register.">PHY_RST_REG</a>, 2, &amp;data);
<a name="l00760"></a>00760   <span class="comment">/* Disable Auto-negotiation.1. Reset PHY. */</span>
<a name="l00761"></a>00761   <span class="comment">/* Set Speed to either 100Base-TX or 10Base-T. */</span>
<a name="l00762"></a>00762   <span class="comment">/* Set Duplex to full-duplex. */</span>
<a name="l00763"></a>00763   <span class="comment">/* Set PHY register 0.14 to 1 to enable Local Loop-back. */</span>
<a name="l00764"></a>00764   data  = <a class="code" href="group__ksz8851snl.html#gafd5294adf51575bf765d1dc7d126fa91" title="Enable Digital loopback mode.">DIGITAL_LOOPBACK</a> | <a class="code" href="group__ksz8851snl.html#gaeaf13b5ca57ed5dcdae7a70e08f6f13a" title="Force full duplex.">FORCE_FULL_DUPLEX</a> | <a class="code" href="group__ksz8851snl.html#ga8da7f27ab085e4ae5ced03050ecc2651" title="Force the speed to 100MBps.">FORCE_100</a>;
<a name="l00765"></a>00765   data &amp;= ~<a class="code" href="group__ksz8851snl.html#ga543c952d3573ec9a703cbf3470f69b1c" title="Force auto negotiation.">AUTO_NEG</a>;
<a name="l00766"></a>00766   <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gabde589971fba1de4265e49a589b144c1" title="PHY1 MII-Register Basic Control Register.">PHY1_CTRL_REG</a>, 2, &amp;data);
<a name="l00767"></a>00767 
<a name="l00768"></a>00768   <a class="code" href="ksz8851snl_8c.html#ad6e6d3b7ae9b4a24e5d61110c0bd24dc" title="Prints a message with a predetermined exception level Support method used for debugging...">KSZ8851SNL_ExceptionHandler</a>(INFO, <span class="stringliteral">&quot;Loopback mode initiated&quot;</span>);
<a name="l00769"></a>00769 }
<a name="l00770"></a>00770 <span class="preprocessor">#endif </span><span class="comment">/* KSZ8851SNL_DEBUG */</span>
<a name="l00771"></a>00771 
<a name="l00772"></a>00772 
<a name="l00773"></a>00773 <span class="comment">/***************************************************************************/</span>
<a name="l00784"></a><a class="code" href="group__ksz8851snl.html#ga92d5dacd3df2c5ae005d3b13b2680b4d">00784</a> uint16_t <a class="code" href="group__ksz8851snl.html#ga92d5dacd3df2c5ae005d3b13b2680b4d" title="Performs the actual receive of a raw frame over the network.">KSZ8851SNL_Receive</a>(uint8_t *pRXData, uint16_t *pRXLength)
<a name="l00785"></a>00785 {
<a name="l00786"></a>00786   uint16_t data;
<a name="l00787"></a>00787   uint8_t  *pDummy = pRXData;
<a name="l00788"></a>00788   uint16_t rxFrameCount, rxftr;
<a name="l00789"></a>00789   uint16_t rxStatus;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791   EFM_ASSERT(pRXData != NULL);
<a name="l00792"></a>00792   EFM_ASSERT(pRXLength != NULL);
<a name="l00793"></a>00793 
<a name="l00794"></a>00794   <span class="comment">/* Read the frame count and threshold register */</span>
<a name="l00795"></a>00795   <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7813d31a11c56dece7ddd366c0fc8cda" title="RX Frame Count &amp;amp; Threshold Register.">RX_FRAME_THRES_REG</a>, 2, &amp;rxftr);
<a name="l00796"></a>00796   <span class="comment">/* Extract the actual number of frames from RX_FRAME_THRES_REG*/</span>
<a name="l00797"></a>00797   rxFrameCount = rxftr &gt;&gt; <a class="code" href="group__ksz8851snl.html#gaebafa824e034291924298c85bc366e0e" title="Used to mark the MSB pos.">MSB_POS</a>;
<a name="l00798"></a>00798 
<a name="l00799"></a>00799   <span class="keywordflow">while</span> (rxFrameCount &gt; 0)
<a name="l00800"></a>00800   {
<a name="l00801"></a>00801     <span class="comment">/* Read the received frame status */</span>
<a name="l00802"></a>00802     <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gafbfe8d3f64212e7bda2413aab25c8b7f" title="Receive Frame Header Status Register.">RX_FRH_STAT_REG</a>, 2, &amp;rxStatus);
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     <span class="comment">/* Check the consistency of the frame */</span>
<a name="l00805"></a>00805     <span class="keywordflow">if</span> (!(rxStatus &gt;&gt; <a class="code" href="group__ksz8851snl.html#gaad58341bdb37284771a7d2551ed18b1c" title="Received valid frame byte pos.">RECEIVED_FRAME_VALID_POS</a> == 0) || ((rxStatus &amp; <a class="code" href="group__ksz8851snl.html#ga746bd8cb4ad1c3ddc653e2029c98cc5c" title="CRC OK for ICMP, IP, TCP, UDP; / MII error; / Frame too long error.">RECEIVE_VALID_FRAME_MASK</a>) == RECEIVE_VALID_FRAME_MASK))
<a name="l00806"></a>00806     {
<a name="l00807"></a>00807       <span class="comment">/* Issue the Release error frame command */</span>
<a name="l00808"></a>00808       <a class="code" href="ksz8851snl_8c.html#a92d3dd835f6bf9055f25702d288adbe6" title="Realease the current frame if it is inconsistent.">KSZ8851SNL_ReleaseIncosistentFrame</a>();
<a name="l00809"></a>00809     }
<a name="l00810"></a>00810     <span class="keywordflow">else</span>
<a name="l00811"></a>00811     {
<a name="l00812"></a>00812       <span class="comment">/* Read the byte size of the received frame */</span>
<a name="l00813"></a>00813       <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#ga05e7b3e4b51a550924f288853f8fff71" title="Receive Frame Header Bytecount Register.">RX_FRH_BC_REG</a>, 2, pRXLength);
<a name="l00814"></a>00814 
<a name="l00815"></a>00815       *pRXLength &amp;= <a class="code" href="group__ksz8851snl.html#ga60cd22a6881b225ea028f8bc1a0e0783" title="Used to mask the reserved bits.">RX_BYTE_CNT_MASK</a>;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817       <span class="keywordflow">if</span> (*pRXLength &lt;= 0)
<a name="l00818"></a>00818       {
<a name="l00819"></a>00819         <span class="comment">/* Issue the Release error frame command */</span>
<a name="l00820"></a>00820         <a class="code" href="ksz8851snl_8c.html#a92d3dd835f6bf9055f25702d288adbe6" title="Realease the current frame if it is inconsistent.">KSZ8851SNL_ReleaseIncosistentFrame</a>();
<a name="l00821"></a>00821         <span class="comment">/* Discard the frame*/</span>
<a name="l00822"></a>00822         rxFrameCount--;
<a name="l00823"></a>00823         <span class="comment">/* continue to next frame */</span>
<a name="l00824"></a>00824         <span class="keywordflow">continue</span>;
<a name="l00825"></a>00825       }
<a name="l00826"></a>00826 
<a name="l00827"></a>00827       <span class="comment">/* Reset QMU RXQ frame pointer to zero */</span>
<a name="l00828"></a>00828       data = <a class="code" href="group__ksz8851snl.html#ga56cdd36751f5a5ba51247720848a46ae" title="Used to reset the FD pointer.">FD_PTR_AUTO_INC</a>;
<a name="l00829"></a>00829       <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gaa6ad569f0f68a727c46f136f057c6436" title="RX Frame Data Pointer Register.">RX_FD_PTR_REG</a>, 2, &amp;data);
<a name="l00830"></a>00830 
<a name="l00831"></a>00831       <span class="comment">/* Start QMU DMA transfer */</span>
<a name="l00832"></a>00832       <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00833"></a>00833       data |= <a class="code" href="group__ksz8851snl.html#gad6f57d490fb0b52fbd122d4664c9592f" title="Start QMU transfer operation.">RXQ_START</a>;
<a name="l00834"></a>00834       <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00835"></a>00835 
<a name="l00836"></a>00836       <span class="comment">/* Start the SPI transfer */</span>
<a name="l00837"></a>00837       <a class="code" href="group__EthSpi.html#gaa0ee08019f1f7e7fa110d51a124adac3" title="Start reading from the ethernet controller FIFO.">ETHSPI_StartReadFIFO</a>();
<a name="l00838"></a>00838 
<a name="l00839"></a>00839       <span class="comment">/* Read 4 dummy, 2 status word and 2 bytecount bytes of the frame header */</span>
<a name="l00840"></a>00840       <a class="code" href="group__EthSpi.html#ga00a4bce5dd1c5925ad2ee7f440cf71ce" title="Continue reading ethernet controller FIFO.">ETHSPI_ReadFifoContinue</a>(4, pDummy);
<a name="l00841"></a>00841       <a class="code" href="group__EthSpi.html#ga00a4bce5dd1c5925ad2ee7f440cf71ce" title="Continue reading ethernet controller FIFO.">ETHSPI_ReadFifoContinue</a>(2, pDummy);
<a name="l00842"></a>00842       <a class="code" href="group__EthSpi.html#ga00a4bce5dd1c5925ad2ee7f440cf71ce" title="Continue reading ethernet controller FIFO.">ETHSPI_ReadFifoContinue</a>(2, pDummy);
<a name="l00843"></a>00843 
<a name="l00844"></a>00844       <span class="comment">/* Remove the first 2 extra bytes consisting of the 2 bytes offset*/</span>
<a name="l00845"></a>00845       <a class="code" href="group__EthSpi.html#ga00a4bce5dd1c5925ad2ee7f440cf71ce" title="Continue reading ethernet controller FIFO.">ETHSPI_ReadFifoContinue</a>(2, pDummy);
<a name="l00846"></a>00846       *pRXLength -= 2;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848       <span class="comment">/* Read the received data */</span>
<a name="l00849"></a>00849       <a class="code" href="group__EthSpi.html#ga00a4bce5dd1c5925ad2ee7f440cf71ce" title="Continue reading ethernet controller FIFO.">ETHSPI_ReadFifoContinue</a>(*pRXLength, pRXData);
<a name="l00850"></a>00850 
<a name="l00851"></a>00851       <span class="comment">/* Stoping the SPI transfer */</span>
<a name="l00852"></a>00852       <a class="code" href="group__EthSpi.html#ga0d7054f02bb0f76d2aae18ead51398da" title="Stop read/write the ethernet controller FIFO.">ETHSPI_StopFIFO</a>();
<a name="l00853"></a>00853 
<a name="l00854"></a>00854       <span class="comment">/* Stop QMU DMA transfer */</span>
<a name="l00855"></a>00855       <a class="code" href="group__EthSpi.html#ga6264b984cc8745fe5d1ce6686e5fedda" title="Read ethernet controller register.">ETHSPI_ReadRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00856"></a>00856       data &amp;= ~<a class="code" href="group__ksz8851snl.html#gad6f57d490fb0b52fbd122d4664c9592f" title="Start QMU transfer operation.">RXQ_START</a>;
<a name="l00857"></a>00857       <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#gacbb511ee04f8548165ed89a46a2818bc" title="RXQ Command Register.">RXQ_CMD_REG</a>, 2, &amp;data);
<a name="l00858"></a>00858 
<a name="l00859"></a>00859       <span class="comment">/* Enable interupts */</span>
<a name="l00860"></a>00860       data = <a class="code" href="group__ksz8851snl.html#ga1f20727c5c478956c891fb9919bdf338" title="Interrupt mask initialization collection.">INT_MASK_EXAMPLE</a>;
<a name="l00861"></a>00861       <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00862"></a>00862 
<a name="l00863"></a>00863       <span class="comment">/* Remove the last 4 extra bytes consisting of the CRC field*/</span>
<a name="l00864"></a>00864       *pRXLength -= 4;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866       <span class="comment">/* After reading one frame, we return its length.</span>
<a name="l00867"></a>00867 <span class="comment">       *   Can also be implemented as callback function</span>
<a name="l00868"></a>00868 <span class="comment">       *   but it is not the purpose of lwIP implementation</span>
<a name="l00869"></a>00869 <span class="comment">       */</span>
<a name="l00870"></a>00870       <span class="keywordflow">return</span> *pRXLength;
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873     <span class="comment">/* Finished reading one frame */</span>
<a name="l00874"></a>00874     rxFrameCount--;
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     <span class="comment">/* Enable interupts */</span>
<a name="l00877"></a>00877     data = <a class="code" href="group__ksz8851snl.html#ga1f20727c5c478956c891fb9919bdf338" title="Interrupt mask initialization collection.">INT_MASK_EXAMPLE</a>;
<a name="l00878"></a>00878     <a class="code" href="group__EthSpi.html#ga83a481920a667139f7e5cfba3bc28c2f" title="Write ethernet controller register.">ETHSPI_WriteRegister</a>(<a class="code" href="group__ksz8851snl.html#ga7d4f0c7cc6166a9a7a8d3fa8dd3582a9" title="Interrupt Enable Register.">INT_ENABLE_REG</a>, 2, &amp;data);
<a name="l00879"></a>00879   }
<a name="l00880"></a>00880   <span class="keywordflow">return</span> 0;
<a name="l00881"></a>00881 }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883 
<a name="l00884"></a>00884 <span class="comment">/***************************************************************************/</span>
<a name="l00890"></a><a class="code" href="group__ksz8851snl.html#gacbdbe4a02c390b610787f7913b6d183c">00890</a> <span class="keywordtype">void</span> <a class="code" href="group__ksz8851snl.html#gacbdbe4a02c390b610787f7913b6d183c" title="Get the MAC address of the current board.">KSZ8851SNL_GetMacAddress</a>(uint8_t *macAddress)
<a name="l00891"></a>00891 {
<a name="l00892"></a>00892   <span class="comment">/* TODO:  Get MAC based on actual MAC and not on the CMU unique ID. */</span>
<a name="l00893"></a>00893 
<a name="l00894"></a>00894   EFM_ASSERT(macAddress != NULL);
<a name="l00895"></a>00895 
<a name="l00896"></a>00896   <span class="comment">/* set the first 3 bytes given by the EM MAC Address space */</span>
<a name="l00897"></a>00897   macAddress[0] = <a class="code" href="group__ksz8851snl.html#gae3b1a19388873dd5c03e63feecff9c14" title="1st segment of the MAC address">HIGH_QMU_MAC_H</a>;
<a name="l00898"></a>00898   macAddress[1] = <a class="code" href="group__ksz8851snl.html#ga8aa3036cea0079ddc98c874ffbd24125" title="2nd segment of the MAC address">HIGH_QMU_MAC_L</a>;
<a name="l00899"></a>00899   macAddress[2] = <a class="code" href="group__ksz8851snl.html#gaa5a2ce4eeabfe5f74d047bcfece64724" title="3rd segment of the MAC address">MID_QMU_MAC_H</a>;
<a name="l00900"></a>00900   <span class="comment">/* set the next 3 bytes given by the CMU unique ID */</span>
<a name="l00901"></a>00901   <span class="keywordtype">int</span> i;
<a name="l00902"></a>00902   <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)
<a name="l00903"></a>00903   {
<a name="l00904"></a>00904     macAddress[5 - i] = (DEVINFO-&gt;UNIQUEL &amp; (BYTE_MASK &lt;&lt; i * BYTE_SIZE)) &gt;&gt; i * <a class="code" href="group__ksz8851snl.html#ga86fd4404b140711fdb77326609c0f393" title="Used to mark the MSB pos.">BYTE_SIZE</a>;
<a name="l00905"></a>00905   }
<a name="l00906"></a>00906 }
<a name="l00907"></a>00907 
</pre></div></div>
<div id="footer">
<hr size="1"><address style="text-align: right;"><small>
Generated on Fri Nov 9 16:47:43 2012</small> for Board Support Package by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a><small> 1.6.3 </small></address></div>
</body>
</html>
